name: â˜ï¸ Cloud Factory (Auto-Invent)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-ship:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ“± Prebuild iOS Project
        run: npx expo prebuild --platform ios --no-install

      - name: ðŸ’Ž Install Fastlane
        run: sudo gem install fastlane

      - name: ðŸ”¨ Install CocoaPods
        run: |
          cd ios
          pod install

      - name: ðŸŽ Sign & Build (or Ship)
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          cd ios
          
          # Initialize Fastlane
          mkdir -p fastlane
          
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "âš ï¸ No Signing Keys found. Running Unsigned Build (Dry Run)."
            xcodebuild archive -workspace AutoInvent.xcworkspace -scheme AutoInvent -destination "generic/platform=iOS" -archivePath AutoInvent.xcarchive CODE_SIGNING_ALLOWED=NO
          else
            echo "âœ… Signing Keys found! Configuring Fastlane..."
            
            # Create dynamic Fastfile
            cat > fastlane/Fastfile <<EOF
            default_platform(:ios)
            platform :ios do
              desc "Auto-Invent Cloud Build"
              lane :release do
                build_app(workspace: "AutoInvent.xcworkspace", scheme: "AutoInvent")
                upload_to_app_store(
                  force: true,
                  skip_waiting_for_build_processing: true,
                  app_identifier: "com.autoinvent.app",
                  api_key: {
                    key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
                    issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
                    key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
                    is_key_content_base64: false
                  }
                )
              end
            end
            EOF

            # Create dynamic Appfile
            cat > fastlane/Appfile <<EOF
            app_identifier "com.autoinvent.app"
            apple_id "your-apple-id@example.com" # Not strictly used with API Key auth but Fastlane complains sometimes
            itc_team_id "YOUR_TEAM_ID" # Optional
            EOF
            
            fastlane ios release
          fi

      - name: ðŸ“¤ Upload Artifact (Unsigned)
        if: ${{ env.APP_STORE_CONNECT_API_KEY_ID == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: auto-invent-ios-unsigned
          path: ios/AutoInvent.xcarchive
