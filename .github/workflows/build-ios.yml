name: â˜ï¸ Cloud Factory (Auto-Invent)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-ship:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ“± Prebuild iOS Project
        run: npx expo prebuild --platform ios --no-install

      - name: ðŸ’Ž Install Fastlane
        run: sudo gem install fastlane

      - name: ðŸ”¨ Install CocoaPods
        run: |
          cd ios
          pod install

      - name: ðŸŽ Sign & Build (or Ship)
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          cd ios
          mkdir -p fastlane
          
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "âš ï¸ No Signing Keys found. Running Unsigned Build."
            xcodebuild archive -workspace AutoInvent.xcworkspace -scheme AutoInvent -destination "generic/platform=iOS" -archivePath AutoInvent.xcarchive CODE_SIGNING_ALLOWED=NO
          else
            echo "âœ… Signing Keys found! Configuring Fastlane..."
            
            # Create Fastfile (Using simple echo to avoid HEREDOC issues in YAML)
            echo "default_platform(:ios)" > fastlane/Fastfile
            echo "platform :ios do" >> fastlane/Fastfile
            echo "  lane :release do" >> fastlane/Fastfile
            echo "    build_app(workspace: 'AutoInvent.xcworkspace', scheme: 'AutoInvent')" >> fastlane/Fastfile
            echo "    upload_to_app_store(" >> fastlane/Fastfile
            echo "      force: true," >> fastlane/Fastfile
            echo "      skip_waiting_for_build_processing: true," >> fastlane/Fastfile
            echo "      app_identifier: 'com.autoinvent.app'," >> fastlane/Fastfile
            echo "      api_key: {" >> fastlane/Fastfile
            echo "        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID']," >> fastlane/Fastfile
            echo "        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID']," >> fastlane/Fastfile
            echo "        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT']," >> fastlane/Fastfile
            echo "        is_key_content_base64: false" >> fastlane/Fastfile
            echo "      }" >> fastlane/Fastfile
            echo "    )" >> fastlane/Fastfile
            echo "  end" >> fastlane/Fastfile
            echo "end" >> fastlane/Fastfile

            # Create Appfile
            echo "app_identifier 'com.autoinvent.app'" > fastlane/Appfile
            echo "apple_id 'ignored@example.com'" >> fastlane/Appfile
            
            fastlane ios release
          fi

      - name: ðŸ“¤ Upload Artifact (Unsigned)
        if: ${{ env.APP_STORE_CONNECT_API_KEY_ID == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: auto-invent-ios-unsigned
          path: ios/AutoInvent.xcarchive
